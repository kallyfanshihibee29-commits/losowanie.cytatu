<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Codzienny Cytat</title>
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Zapisana szata graficzna */
      --bg:#9fc6e2;
      --navy:#1e3a8a;
      --white:#ffffff;
      --quote-grad-start:#3b5998;
      --quote-grad-end:#5a8dee;
      --container-w:760px;
      --rounded:16px;
      --card-h:120px;
      --gap:16px;

      /* dodatkowe (pomocnicze) */
      --cap-gray:#8a8f91;
      --cap-green:#2e8b57;
      --cap-blue:#2563eb;
      --cap-purple:#7c3aed;
      --cap-navy:#243b6b;
      --cap-red:#c62828;
      --cap-gold:#cfa200;
    }
    *{box-sizing:border-box}
    body{ margin:0;min-height:100vh; font-family:Roboto,Arial,sans-serif; background: linear-gradient(180deg,var(--bg) 0%, #cfe8f8 100%); display:flex;align-items:center;justify-content:center;padding:20px; }
    .app{ width:100%;max-width:var(--container-w); background:var(--white);border-radius:var(--rounded); padding:20px;box-shadow:0px 8px 28px rgba(0,0,0,0.12); color:var(--navy);overflow:hidden; transform-origin:center;opacity:0;transform:translateY(8px) scale(.995); animation:appIn .45s ease forwards; position:relative; }
    @keyframes appIn{to{opacity:1;transform:none}}
    header{ text-align:center;margin-bottom:8px }
    h1{font-family:Pacifico, cursive;color:var(--navy);font-size:28px;margin:4px 0}
    .subtitle{color:rgba(30,58,138,.8);font-size:13px}

    /* Quote box uses stored gradient */
    .quote-box{ background:linear-gradient(135deg,var(--quote-grad-start),var(--quote-grad-end)); color:var(--white);padding:18px;border-radius:12px;min-height:140px;display:flex;align-items:center;justify-content:center;text-align:center; font-size:18px;line-height:1.4;margin:14px 0;box-shadow:0 10px 30px rgba(58,88,160,.12); }
    .quote-ref{display:block;margin-top:10px;font-size:13px;opacity:.95}

    .controls{display:flex;gap:12px;align-items:center;justify-content:center;margin:12px 0}
    /* button uses stored gradient */
    .btn{ background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));color:var(--white);border:none;padding:12px 22px;border-radius:12px;font-weight:700;cursor:pointer;font-size:15px;box-shadow:0 6px 16px rgba(58,88,160,.15); transition:transform .18s ease,box-shadow .18s ease;outline:none; }
    .btn:active{transform:translateY(2px)}
    .btn:disabled{background:#c4c4c4;cursor:not-allowed;box-shadow:none}
    .btn.pulse{animation:pulse 3.5s infinite}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.03)}100%{transform:scale(1)}}

    .meta{display:flex;justify-content:space-between;align-items:center;margin-top:8px;flex-wrap:wrap;gap:8px}
    .streak{font-weight:700;display:flex;flex-direction:column;gap:6px}
    .streak-row{display:flex;align-items:center;gap:8px}
    .streak #flameIcon{display:inline-flex;align-items:center}
    .countdown{font-style:italic;color:var(--navy)}

    /* medals area */
    .medals-section{margin-top:20px}
    .medals-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .medal-strip{display:flex;gap:12px;overflow-x:auto;padding-bottom:10px;scroll-snap-type:x mandatory;}
    .medal-strip::-webkit-scrollbar{height:10px}
    .medal-strip::-webkit-scrollbar-thumb{background:linear-gradient(180deg,var(--quote-grad-end),var(--quote-grad-start));border-radius:8px}
    .medal-card{flex:0 0 180px;background:linear-gradient(180deg,#fff,#f6fbff);border-radius:12px;padding:12px;border:1px solid rgba(30,58,138,.06);box-shadow:0 8px 18px rgba(30,58,138,.04);height:var(--card-h);display:flex;flex-direction:column;justify-content:space-between;scroll-snap-align:start}
    .medal-top{display:flex;align-items:center;gap:8px}
    .medal-tag{font-size:22px; width:36px; height:36px; display:flex; align-items:center; justify-content:center}
    .medal-name{font-weight:700;color:var(--navy)}
    .medal-days{font-size:13px;color:rgba(30,58,138,.7)}
    .medal-missing{font-size:13px;color:rgba(30,58,138,.75);margin-top:6px}
    .medal-caption{font-size:13px;font-weight:700;margin-top:6px}

    /* autumn gradient text for captions */
    .cap-autumn{
      font-weight:700;
      background: linear-gradient(90deg,#8B5A2B,#d15518,#6b8e23);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      color: transparent;
    }

    .cap-gray{color:var(--cap-gray)}
    .cap-green{color:var(--cap-green)}
    .cap-blue{color:var(--cap-blue)}
    .cap-purple{color:var(--cap-purple)}
    .cap-navy{color:var(--cap-navy)}
    .cap-red{color:var(--cap-red)}
    .cap-gold{color:var(--cap-gold)}

    .medal-pool{margin-top:20px;padding:18px;border-radius:12px;background:linear-gradient(180deg,#f8fbff,#ffffff);border:1px solid rgba(30,58,138,.06)}
    .medal-pool .title{font-size:14px;color:rgba(30,58,138,.85);font-weight:700;margin-bottom:12px}
    .medal-pool .note{font-size:13px;color:rgba(30,58,138,.65);margin-bottom:10px}

    .progress-wrap{position:relative;height:18px;background:rgba(30,58,138,.06);border-radius:12px;overflow:visible}
    .progress-fill{position:absolute;left:0;top:0;height:100%;border-radius:12px;background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));width:0%;transition:width .6s ease}
    .marker{position:absolute;top:-34px;transform:translateX(-50%);text-align:center;font-size:12px}
    .marker .dot{width:10px;height:10px;border-radius:50%;background:#fff;border:2px solid rgba(30,58,138,.8);display:inline-block}
    .progress-legend{display:flex;justify-content:space-between;margin-top:12px;font-size:13px;color:rgba(30,58,138,.7)}
    .tooltip{position:absolute;transform:translateX(-50%);padding:6px 8px;border-radius:6px;background:var(--navy);color:#fff;font-size:12px;white-space:nowrap;top:-48px;display:none}

    .progress-popup{min-width:160px;max-width:320px}
    .claim-btn{background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end));border:none;color:#fff;padding:6px 10px;border-radius:8px;font-weight:700;cursor:pointer} 

    .history{margin-top:18px;border-top:1px solid rgba(30,58,138,.08);padding-top:14px}
    .history h3{margin:6px 0;color:var(--navy);display:flex;align-items:center;gap:10px}
    .history-list{max-height:220px;overflow:auto;padding:10px;border-radius:8px;border:1px solid rgba(30,58,138,.08);background:#fff}
    .history-item{font-size:14px;padding:10px 8px;border-bottom:1px dashed rgba(30,58,138,.05) }

    footer{font-size:12px;text-align:center;color:rgba(30,58,138,.7);margin-top:12px}

    /* ENTRY ANIMATIONS */
    @keyframes slideInFromLeft{from{opacity:0;transform:translateX(-28px)}to{opacity:1;transform:none}}
    header{opacity:0;animation:slideInFromLeft .5s cubic-bezier(.2,.9,.2,1) forwards .08s}
    .quote-box{opacity:0;animation:slideInFromLeft .55s cubic-bezier(.2,.9,.2,1) forwards .16s}
    .controls{opacity:0;animation:slideInFromLeft .55s cubic-bezier(.2,.9,.2,1) forwards .24s}
    .meta{opacity:0;animation:slideInFromLeft .55s cubic-bezier(.2,.9,.2,1) forwards .32s}
    .medals-section{opacity:0;animation:slideInFromLeft .55s cubic-bezier(.2,.9,.2,1) forwards .40s}
    .history{opacity:0;animation:slideInFromLeft .55s cubic-bezier(.2,.9,.2,1) forwards .48s}
    footer{opacity:0;animation:slideInFromLeft .55s cubic-bezier(.2,.9,.2,1) forwards .56s}

    /* MOBILE ADJUSTMENTS */
    @media (max-width:720px){
      body{padding:12px}
      .app{padding:14px}
      .quote-box{min-height:160px;font-size:16px;padding:16px}
      .medal-card{flex:0 0 78%;height:150px}
      .medal-strip{gap:10px}
      .meta{flex-direction:column;align-items:flex-start;gap:6px}
      .controls{margin-top:8px}
      .medal-pool{margin-top:16px;padding:14px}
      .progress-wrap{height:22px}
      .marker{top:-44px}
      .history-list{max-height:240px}
    }

    @media (max-width:420px){
      h1{font-size:22px}
      .medal-card{flex:0 0 86%;height:160px}
      .quote-box{min-height:170px}
      .btn{padding:10px 16px;font-size:15px}
    }
  
    /* left external link (HALF SIZE compared to previous) */
    .external-link{
      position:absolute;
      top:8px;
      left:8px;
      width:28px;  /* reduced about half */
      height:28px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      background:linear-gradient(135deg,var(--quote-grad-start) 0%,var(--quote-grad-end) 100%);
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      transition:transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      z-index:1000;
      border:1px solid rgba(255,255,255,0.06);
    }
    .external-link svg{ width:14px; height:14px; display:block; fill:#ffffff; transform:rotate(180deg); }

    /* right-side search/code icon */
    .search-link{
      position:absolute;
      top:10px;
      right:10px;
      width:44px;
      height:44px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      text-decoration:none;
      background:linear-gradient(135deg,var(--quote-grad-start) 0%,var(--quote-grad-end) 100%);
      box-shadow:0 10px 30px rgba(0,0,0,0.12);
      transition:transform .18s ease, box-shadow .18s ease, opacity .12s ease;
      z-index:1000;
      border:1px solid rgba(255,255,255,0.06);
      cursor:pointer;
    }
    .search-link svg{ width:20px; height:20px; display:block; fill:#fff; }

    /* popup with code input */
    .code-popup{
      position:absolute;
      top:60px;
      right:10px;
      width:260px;
      max-width:calc(100% - 40px);
      background:#fff;
      border-radius:10px;
      box-shadow:0 12px 30px rgba(0,0,0,0.14);
      padding:10px;
      z-index:1100;
      display:none;
    }
    .code-popup.visible{ display:block; }
    .code-popup form{ display:flex; gap:8px; align-items:center; }
    .code-popup input[type="text"]{ flex:1; padding:8px 10px; border-radius:8px; border:1px solid rgba(30,58,138,.08); font-size:14px; }
    .code-popup button{ padding:8px 10px; border-radius:8px; border:none; background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end)); color:#fff; font-weight:700; cursor:pointer; }

    /* small clear history button near history header */
    .clear-history-btn{
      background:transparent;
      border:none;
      color:rgba(30,58,138,.7);
      cursor:pointer;
      padding:6px;
      border-radius:8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .clear-history-btn svg{ width:16px; height:16px; display:block; fill:rgba(30,58,138,.7); }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>Codzienny Cytat</h1>
      <div class="subtitle">Losuj cytat z Pisma Świętego — jeden raz dziennie. Twoja CytatPassa nalicza dni z rzędu.</div>
    </header>

    <!-- left small arrow (half-size) -->
    <a class="external-link" href="https://blogwpg.my.canva.site/" target="_blank" rel="noopener" aria-label="Odwiedź blog">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M8.59 16.59L13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>
    </a>

    <!-- right-side search/code icon -->
    <div class="search-link" id="searchToggle" title="Wprowadź kod">
      <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false"><path d="M15.5 14h-.79l-.28-.27A6.471 6.471 0 0016 9.5 6.5 6.5 0 109.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zM10 14a4 4 0 110-8 4 4 0 010 8z"/></svg>
    </div>

    <!-- code popup (hidden until clicking search icon) -->
    <div class="code-popup" id="codePopup" aria-hidden="true">
      <form id="codeForm">
        <input id="codeInput" type="text" inputmode="latin" autocomplete="off" placeholder="Wpisz kod specjalny" aria-label="Kod specjalny" />
        <button type="submit" id="codeApplyBtn">Zastosuj</button>
      </form>
      <div id="codeMsg" style="margin-top:8px;font-size:13px;color:var(--navy);display:none"></div>
    </div>

    <main>
      <div class="quote-box" id="quoteBox" role="region" aria-live="polite">
        <div>
          <div id="quoteText">Kliknij „Losuj Cytat”, aby otrzymać dzisiejszy cytat.</div>
          <div class="quote-ref" id="quoteRef"></div>
        </div>
      </div>

      <div class="controls">
        <button id="drawBtn" class="btn pulse" aria-pressed="false">Losuj Cytat</button>
      </div>

      <div class="meta">
        <div class="streak">
          <div class="streak-row">Twoja CytatPassa: <span id="streakValue" style="margin-left:8px">0</span> dni <span id="flameIcon" aria-hidden="true" title="Status losowania"></span></div>
          <div class="streak-row" style="font-weight:600;color:rgba(30,58,138,.85)">Twoje CytatPunkty: <span id="pointsValue" style="margin-left:8px">0</span></div>
        </div>
        <div class="countdown" id="countdown" style="min-width:200px">Nie losowano jeszcze</div>
      </div>

      <section class="medals-section">
        <div class="medals-header">
          <h3 style="margin:0">Nagrody Jesiennego Seoznu</h3>
          <div style="font-size:13px;color:rgba(30,58,138,.7)">Przesuń, aby zobaczyć wszystkie</div>
        </div>

        <div class="medal-strip" id="medalStrip" aria-label="Lista medali">
          <!-- karty medali wypełniane JS -->
        </div>

        <div class="medal-pool" aria-hidden="false">
          <div class="title">Postęp do kolejnych medali</div>
          
          <div class="progress-wrap" id="progressWrap">
            <div class="progress-fill" id="progressFill"></div>
            <!-- markery dodawane JS (bez etykiet - tylko kropki) -->
          </div>
          <div class="progress-legend" id="progressLegend">
            <div id="legendLeft">0 dni</div>
            <div id="legendRight">0 dni</div>
          </div>
        </div>
      </section>

      <div class="history">
        <h3>
          Historia cytatów
          <!-- clear history button (trash) -->
          <button class="clear-history-btn" id="clearHistoryBtn" title="Wyczyść historię cytatów" aria-label="Wyczyść historię cytatów">
            <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M6 19a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
          </button>
        </h3>
        <div class="history-list" id="historyList">Brak zapisanych cytatów.</div>
      </div>
    </main>

    <footer>Wszystkie dane przechowywane lokalnie w przeglądarce. Działa offline.</footer>
  </div>

  <script>
    // --- DANE: cytaty (polskie) ---
    const QUOTES = [
      {text: 'Bóg jest miłością.', ref: '1 Jana 4:8'},
      {text: 'Pan jest moim pasterzem, niczego mi nie braknie.', ref: 'Psalm 23:1-2'},
      {text: 'Wszystko mogę w Tym, który mnie umacnia.', ref: 'List do Filipian 4:13'},
      {text: 'Niech będzie wolna wola twoja.', ref: 'Ewangelia Mateusza 6:10'},
      {text: 'Miłuj bliźniego swego jak siebie samego.', ref: 'Ewangelia Mateusza 22:39'},
      {text: 'Proście, a będzie wam dane; szukajcie, a znajdziecie.', ref: 'Ewangelia Mateusza 7:7'},
      {text: 'Prawda was wyzwoli.', ref: 'Ewangelia Jana 8:32'},
      {text: 'Pan jest światłem moim i zbawieniem moim.', ref: 'Psalm 27:1'},
      {text: 'Ufaj Panu z całego serca.', ref: 'Przysłów 3:5'},
      {text: 'Albowiem gdzie jest skarb twój, tam będzie i serce twoje.', ref: 'Ewangelia Mateusza 6:21'},
      {text: 'Nie lękaj się, bo ja jestem z tobą.', ref: 'Księga Izajasza 41:10'},
      {text: 'Szukajcie najpierw Królestwa Bożego.', ref: 'Ewangelia Mateusza 6:33'},
      {text: 'Pan daje siłę zmęczonemu.', ref: 'Księga Izajasza 40:29'},
      {text: 'Wybaczajcie, a będzie wam przebaczone.', ref: 'Ewangelia Łukasza 6:37'},
      {text: 'Nie sądźcie, abyście nie byli sądzeni.', ref: 'Ewangelia Mateusza 7:1'},
      {text: 'Wszystko ma swój czas.', ref: 'Księga Koheleta 3:1'},
      {text: 'Serce rozradowane jest dobrym lekarstwem.', ref: 'Przysłów 17:22'},
      {text: 'Pan błogosławi bojowi twemu.', ref: 'Księga Jozuego 1:9'},
      {text: 'Miłosierdzie pragnie, a nie ofiary.', ref: 'Ewangelia Mateusza 9:13'},
      {text: 'Bóg zna twoje drogi.', ref: 'Psalm 139:3'},
      {text: 'On uzdrawia złamanych na duchu.', ref: 'Psalm 147:3'},
      {text: 'Dajcie a będzie wam dane.', ref: 'Ewangelia Łukasza 6:38'},
      {text: 'Niechaj twoje serce się nie trwoży.', ref: 'Ewangelia Jana 14:1'},
      {text: 'Bądźcie mocni i mężni.', ref: 'Księga Jozuego 1:6'},
      {text: 'Chleb nasz powszedni daj nam dzisiaj.', ref: 'Modlitwa Pańska'},
      {text: 'Niech będzie pokój w domu twym.', ref: 'Psalm 122:7'},
      {text: 'Słowa twoje są dla mnie światłem.', ref: 'Psalm 119:105'},
      {text: 'Pan jest blisko skruszonych w sercu.', ref: 'Psalm 34:18'},
      {text: 'Kto trwa we Mnie, przynosi owoc obfity.', ref: 'Ewangelia Jana 15:5'},
      {text: 'Bóg jest naszą ucieczką i mocą.', ref: 'Psalm 46:2'},
      {text: 'Czemu się boisz, mała trzódko?', ref: 'Ewangelia Mateusza 8:26'},
      {text: 'Służcie Panu z weselem.', ref: 'Psalm 100:2'},
      {text: 'Niech się nie trwoży serce wasze.', ref: 'Ewangelia Jana 14:27'},
      {text: 'Miłość cierpliwa jest, miłość łaskawa jest.', ref: '1 List do Koryntian 13:4'},
      {text: 'Bóg daje mądrość.', ref: 'List Jakuba 1:5'},
      {text: 'Gdy idę doliną cienia śmierci, nie boję się złego.', ref: 'Psalm 23:4'},
      {text: 'Pan uzdrawia i ratuje.', ref: 'Psalm 103:3'},
      {text: 'Przyjdźcie do mnie wszyscy spracowani.', ref: 'Ewangelia Mateusza 11:28'},
      {text: 'Słudzy Boży powinni być roztropni.', ref: 'Ewangelia Mateusza 10:16'},
      {text: 'Pan jest sprawiedliwy we wszystkich drogach swych.', ref: 'Psalm 145:17'},
      {text: 'Nie chodź w gniewie długo.', ref: 'Efezjan 4:26'},
      {text: 'Królestwo Boże jest wśród was.', ref: 'Ewangelia Łukasza 17:21'},
      {text: 'Daj mi serce czyste, o Boże.', ref: 'Psalm 51:10'},
      {text: 'Wiedząc, że wszystko działa ku dobremu.', ref: 'List do Rzymian 8:28'},
      {text: 'Zaufaj Panu i czyń dobrze.', ref: 'Psalm 37:3'},
      {text: 'Bądźcie jeden dla drugiego wsparciem.', ref: 'List do Hebrajczyków 10:24'},
      {text: 'Pan napełnia głodnych dobrami.', ref: 'Psalm 107:9'},
      {text: 'Nie troszczcie się o jutro.', ref: 'Ewangelia Mateusza 6:34'},
      {text: 'Jezus jest drogą, prawdą i życiem.', ref: 'Ewangelia Jana 14:6'},
      {text: 'Błogosławieni cisi, albowiem oni na własność posiądą ziemię.', ref: 'Ewangelia Mateusza 5:5'},
      {text: 'Pan zna drogę sprawiedliwych.', ref: 'Psalm 1:6'},
      {text: 'Gdzie dwaj albo trzej zgromadzeni są...', ref: 'Ewangelia Mateusza 18:20'},
      {text: 'Bóg przemawia w ciszy.', ref: '1 Krl 19:12'},
      {text: 'Niech nikt nie gardzi twoją młodością.', ref: '1 List do Tymoteusza 4:12'},
      {text: 'Pan podnosi pokornych.', ref: 'Psalm 147:6'},
      {text: 'Twoje grzechy są przebaczone.', ref: 'Ewangelia Marka 2:5'},
      {text: 'Dziękujcie we wszystkim.', ref: '1 Tesaloniczan 5:18'},
      {text: 'Miłość nie zazdrości, nie szuka poklasku.', ref: '1 Kor 13'},
      {text: 'Strzeż swego serca ponad wszystko, co się strzeże.', ref: 'Przysłów 4:23'},
      {text: 'Pan jest moją siłą i tarczą.', ref: 'Psalm 28:7'},
      {text: 'Nie bój się mała trzódko — łagodnie mówi Pan.', ref: 'Łk 12:32'},
      {text: 'Pan da wam pokój na zawsze.', ref: 'Księga Izajasza 54:10'},
      {text: 'Gdzie miłość, tam i Bóg.', ref: '1 Jana 4:12'},
      {text: 'Wszystko ma swoje piękno w czasie.', ref: 'Kohelet 3:11'},
      {text: 'Pracuj jak dla Pana, nie jak dla ludzi.', ref: 'List do Kolosan 3:23'},
      {text: 'Błogosławieni miłosierni.', ref: 'Ewangelia Mateusza 5:7'},
      {text: 'Pan strzeże twoich kroków.', ref: 'Psalm 121:3'},
      {text: 'Niech twoje słowa będą tak, tak; nie, nie.', ref: 'Ewangelia Mateusza 5:37'},
      {text: 'Kto sieje w łzach, żąć będzie z radością.', ref: 'Psalm 126:5'},
      {text: 'Pan jest wierny swoim obietnicom.', ref: 'List do Hebrajczyków 10:23'},
      {text: 'Dajcie chleb głodnym, wody odwodnionym.', ref: 'Przysłów 31:20'},
      {text: 'Pan nas zawoła po imieniu.', ref: 'Ewangelia Jana 10:3'},
      {text: 'Pan umacnia tych, którzy czekają na niego.', ref: 'Księga Izajasza 40:31'},
      {text: 'Bóg jest sprawiedliwy i miłosierny.', ref: 'Psalm 116:5'},
      {text: 'Niech wasze serca się nie trwożą.', ref: 'J 14:27'},
      {text: 'Panu oddaj chwałę i radość.', ref: 'Psalm 149:4'},
      {text: 'Pan przyjdzie z pomocą tym, którzy go proszą.', ref: 'Ewangelia Łukasza 18:7'},
      {text: 'Nie pozwól, aby zło zwyciężyło dobro.', ref: 'Rzymian 12:21'},
      {text: 'Pan prowadzi ubogich sprawiedliwie.', ref: 'Psalm 25:9'},
      {text: 'Bądź pokorny wobec innych.', ref: 'List do Filipian 2:3'},
      {text: 'Pan w swej dobroci daje łaskę.', ref: 'Tytusa 3:5'},
      {text: 'Wspierajcie się nawzajem modlitwą.', ref: 'Jakuba 5:16'},
      {text: 'Pan jest źródłem mądrości.', ref: 'Przysłów 2:6'},
      {text: 'Niech miłość wasza będzie bez obłudy.', ref: 'Rzymian 12:9'},
      {text: 'Pan jest blisko skruszonych.', ref: 'Psalm 34:18'},
      {text: 'Pan da wam odpocznienie.', ref: 'Mateusz 11:29'},
      {text: 'Trwaj w nadziei i wierze.', ref: 'Rzymian 12:12'},
      {text: 'Pan rozjaśnia nasze drogi.', ref: 'Psalm 119:105'},
      {text: 'Szukajcie sprawiedliwości, a Bóg was wywyższy.', ref: 'Izajasz 56:1'},
      {text: 'Pan jest z tobą na zawsze.', ref: 'Mateusz 28:20'},
      {text: 'Jezus jest pierwszym i ostatnim.', ref: 'Objawienie 1:17-18'},
      {text: 'Bóg zna twoje troski i je niesie.', ref: 'Psalm 55:22'},
      {text: 'Trwajcie w ufności wobec Boga.', ref: 'Hebrajczyków 11:1'},
      {text: 'Pan wysłucha modlitwę pokornych.', ref: 'Psalm 34:17'},
      {text: 'Wierzymy nie widząc, lecz ufamy.', ref: '1 Piotra 1:8'},
      {text: 'Bądźcie światłem dla świata.', ref: 'Mateusz 5:14'},
      {text: 'Niech serce twoje znajdzie pokój w Panu.', ref: 'Psalm 4:8'},
      {text: 'Pan obdarowuje darem ducha.', ref: 'Dzieje Apostolskie 2:38'},
      {text: 'Niech łaska Pana was prowadzi.', ref: '2 Tesaloniczan 2:16'}
    ];

    // rozszerzona lista medali (z Twojego kodu) — bez zmian logicznych
    const MEDALS = [
      {name:'Liść Dębu', days:2, emoji:'🍁', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#8B5A2B"/></svg>`},
      {name:'Liść Klonu', days:5, emoji:'🍂', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#d15518"/></svg>`},
      {name:'Liść Kasztanowca', days:10, emoji:'🍁', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#a73b07"/></svg>`},
      {name:'Liść Brzozy', days:15, emoji:'🍃', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#9fcf9b"/></svg>`},
      {name:'Liść Winorośli', days:20, emoji:'🍇', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#6f2e5a"/></svg>`},
      {name:'Liść Jesionu', days:25, emoji:'🍂', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#6b8e23"/></svg>`},
      {name:'Liść Bukowy', days:30, emoji:'🌿', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#2e8b57"/></svg>`},
      {name:'Liść Sekwoi', days:40, emoji:'🌲', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#704214"/></svg>`},
      {name:'Złoty Liść', days:50, emoji:'🌟', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M21 3s-6 3-9 6-6 9-6 9 6-1 9-4 6-11 6-11z" fill="#cfa200"/></svg>`},

      {name:'Grzyb: Pieczarka', days:60, emoji:'🍄', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#c7b299"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff5e6"/></svg>`},
      {name:'Grzyb: Maślak', days:65, emoji:'🍄', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#d4a84a"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff3d9"/></svg>`},
      {name:'Grzyb: Kurka', days:70, emoji:'🍄', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#ff9b3a"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff0d6"/></svg>`},
      {name:'Grzyb: Podgrzybek', days:75, emoji:'🍄', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#8b5a33"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff7ee"/></svg>`},
      {name:'Grzyb: Prawdziwek', days:80, emoji:'🍄', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#d2b48c"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff6e9"/></svg>`},
      {name:'Grzyb: Muchomor', days:85, emoji:'🍄', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#d94b3a"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff7ee"/><circle cx="10" cy="7" r="0.8" fill="#fff"/><circle cx="13" cy="8.2" r="0.7" fill="#fff"/><circle cx="15.5" cy="6.8" r="0.6" fill="#fff"/></svg>`},
      {name:'Złoty Grzyb', days:100, emoji:'🌟', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="9" rx="8" ry="5" fill="#cfa200"/><rect x="9" y="9" width="6" height="8" rx="3" fill="#fff3d9"/></svg>`},

      {name:'Jabłko', days:105, emoji:'🍎', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="8" fill="#e24b3b"/><path d="M14 5c-.6-1.2-2-2-3.5-2-0.2 1-0.3 2 .5 3 .8 1 2 1 3 0z" fill="#4a6b2a"/></svg>`},
      {name:'Gruszka', days:110, emoji:'🍐', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M12 4c-2 0-4 2-4 4s2 4 4 7 4 3 4 1-1-6-4-12z" fill="#c2a64a"/></svg>`},
      {name:'Śliwka', days:115, emoji:'🍑', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="7" fill="#8b3b8f"/></svg>`},
      {name:'Dynia', days:120, emoji:'🎃', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="13" rx="7" ry="6" fill="#ff8c2b"/><rect x="11" y="6" width="2" height="3" rx="0.5" fill="#6b3f1f"/></svg>`},
      {name:'Marchewka', days:125, emoji:'🥕', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M7 14c2 2 6 2 9 0l-2-6-7 6z" fill="#ff8a3d"/><path d="M14 6l1-2 2 1-1 2z" fill="#6aa84f"/></svg>`},
      {name:'Burak', days:130, emoji:'🧅', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="7" fill="#7a2540"/></svg>`},
      {name:'Ziemniak', days:135, emoji:'🥔', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="12" rx="7" ry="5" fill="#c89f6b"/></svg>`},
      {name:'Orzech włoski', days:145, emoji:'🌰', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><ellipse cx="12" cy="12" rx="6" ry="7" fill="#8b5a2b"/></svg>`},
      {name:'Złote Jabłko', days:150, emoji:'🌟', svg:`<svg width="28" height="28" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><circle cx="12" cy="12" r="8" fill="#cfa200"/><path d="M14 5c-.6-1.2-2-2-3.5-2-0.2 1-0.3 2 .5 3 .8 1 2 1 3 0z" fill="#6b3f1f"/></svg>`}
    ];

    // DOM
    const drawBtn = document.getElementById('drawBtn');
    const quoteText = document.getElementById('quoteText');
    const quoteRef = document.getElementById('quoteRef');
    const streakValueEl = document.getElementById('streakValue');
    const pointsValueEl = document.getElementById('pointsValue');
    const countdownEl = document.getElementById('countdown');
    const historyList = document.getElementById('historyList');

    const medalStrip = document.getElementById('medalStrip');
    const progressFill = document.getElementById('progressFill');
    const progressWrap = document.getElementById('progressWrap');
    const progressLegendLeft = document.getElementById('legendLeft');
    const progressLegendRight = document.getElementById('legendRight');
    const flameIconWrap = document.getElementById('flameIcon');

    const searchToggle = document.getElementById('searchToggle');
    const codePopup = document.getElementById('codePopup');
    const codeForm = document.getElementById('codeForm');
    const codeInput = document.getElementById('codeInput');
    const codeMsg = document.getElementById('codeMsg');

    const clearHistoryBtn = document.getElementById('clearHistoryBtn');

    const LS = { lastDrawDate: 'cd_lastDrawDate', lastQuoteIndex: 'cd_lastQuoteIndex', streak: 'cd_streak', history: 'cd_history', claimedMedals: 'cd_claimedMedals', claimedCodes: 'cd_claimedCodes', points: 'cd_points' };

    function getTodayKey(){ const d = new Date(); const y = d.getFullYear(); const m = String(d.getMonth()+1).padStart(2,'0'); const day = String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
    function loadState(){ const lastDrawDate = localStorage.getItem(LS.lastDrawDate); const lastQuoteIndex = localStorage.getItem(LS.lastQuoteIndex); const streak = parseInt(localStorage.getItem(LS.streak)||'0',10); let history = []; let claimed = []; let claimedCodes = []; let points = parseInt(localStorage.getItem(LS.points)||'0',10); try{ history = JSON.parse(localStorage.getItem(LS.history)||'[]'); claimed = JSON.parse(localStorage.getItem(LS.claimedMedals)||'[]'); claimedCodes = JSON.parse(localStorage.getItem(LS.claimedCodes)||'[]'); }catch(e){ history=[]; claimed=[]; claimedCodes=[]; } return {lastDrawDate,lastQuoteIndex: lastQuoteIndex!==null?parseInt(lastQuoteIndex,10):null,streak: isNaN(streak)?0:streak,history,claimedMedals: Array.isArray(claimed)?claimed:[], claimedCodes: Array.isArray(claimedCodes)?claimedCodes:[], points: isNaN(points)?0:points}; }
    function saveState(state){ if(state.lastDrawDate!==undefined) localStorage.setItem(LS.lastDrawDate,state.lastDrawDate); if(state.lastQuoteIndex!==undefined) localStorage.setItem(LS.lastQuoteIndex,String(state.lastQuoteIndex)); if(state.streak!==undefined) localStorage.setItem(LS.streak,String(state.streak)); if(state.history!==undefined) localStorage.setItem(LS.history,JSON.stringify(state.history)); if(state.claimedMedals!==undefined) localStorage.setItem(LS.claimedMedals,JSON.stringify(state.claimedMedals)); if(state.claimedCodes!==undefined) localStorage.setItem(LS.claimedCodes,JSON.stringify(state.claimedCodes)); if(state.points!==undefined) localStorage.setItem(LS.points,String(state.points)); }
    function daysBetween(a,b){ if(!a || !b) return 0; const da = new Date(a+'T00:00:00'); const db = new Date(b+'T00:00:00'); const diff = Math.floor((Date.UTC(db.getFullYear(),db.getMonth(),db.getDate()) - Date.UTC(da.getFullYear(),da.getMonth(),da.getDate())) / (1000*60*60*24)); return diff; }
    function getNextMidnightMs(){ const now = new Date(); const n = new Date(now.getFullYear(),now.getMonth(),now.getDate()+1,0,0,0,0); return n.getTime(); }

    function nextMedal(streak){ for(let i=0;i<MEDALS.length;i++){ if(streak < MEDALS[i].days) return MEDALS[i]; } return null; }

    // returns caption text + css class to use
    function medalCaptionFor(name){
      // wszystkie rzadkości -> jedna etykieta (Twoje wymaganie)
      return {text:'Nagroda za Jesień 2025', cls:'cap-autumn'};
    }

    function updateFlameIcon(){ const state = loadState(); const today = getTodayKey(); const drawnToday = state.lastDrawDate === today;
      if(drawnToday){
        flameIconWrap.innerHTML = `
          <svg width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <defs>
              <linearGradient id="gA" x1="0" x2="1" y1="0" y2="1">
                <stop offset="0%" stop-color="#3b5998" />
                <stop offset="100%" stop-color="#5a8dee" />
              </linearGradient>
            </defs>
            <path d="M12 2c0 0-4 4-4 8 0 3.5 3 6 4 9 1-3 4-5.5 4-9 0-4-4-8-4-8z" fill="url(#gA)" />
            <path d="M12 5.5c0 0-1.8 1.6-1.8 3.2 0 1.4 1.1 2.4 1.8 3.6.6-1.3 1.8-2.2 1.8-3.6 0-1.6-1.8-3.2-1.8-3.2z" fill="#ffffff" opacity="0.9" />
          </svg>
        `;
        flameIconWrap.setAttribute('title','Zalowano cytat dziś — Twoja CytatPassa aktywna');
      } else {
        flameIconWrap.innerHTML = `
          <svg width="20" height="20" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
            <path d="M12 3c0 0-3 3-3 6 0 2.5 2 4 3 6 1-2 3-3.5 3-6 0-3-3-6-3-6z" fill="#bdbdbd" />
          </svg>
        `;
        flameIconWrap.setAttribute('title','Jeszcze nie wylosowano dzisiaj — ikonka szara');
      }
    }

    function updateCountdown(){ const state = loadState(); const lastDraw = state.lastDrawDate; if(!lastDraw){ countdownEl.textContent = 'Nie losowano jeszcze'; drawBtn.disabled = false; drawBtn.classList.add('pulse'); updateFlameIcon(); return; } const today = getTodayKey(); if(lastDraw === today){ const nextMs = getNextMidnightMs(); const diff = nextMs - Date.now(); if(diff<=0){ countdownEl.textContent = 'Możesz losować!'; drawBtn.disabled=false; drawBtn.classList.add('pulse'); updateFlameIcon(); return; } drawBtn.disabled=true; drawBtn.classList.remove('pulse'); const h = String(Math.floor(diff/3600000)).padStart(2,'0'); const m = String(Math.floor(diff%3600000/60000)).padStart(2,'0'); const s = String(Math.floor(diff%60000/1000)).padStart(2,'0'); countdownEl.textContent = `Następne losowanie za: ${h}:${m}:${s} (strefa lokalna)`; updateFlameIcon(); return; } drawBtn.disabled=false; drawBtn.classList.add('pulse'); countdownEl.textContent = 'Możesz losować!'; updateFlameIcon(); }

    function chooseQuoteAvoidRepeat(lastIndex){ if(QUOTES.length===0) return null; if(QUOTES.length===1) return 0; let idx = Math.floor(Math.random()*QUOTES.length); let attempts=0; while(idx===lastIndex && attempts<50){ idx = Math.floor(Math.random()*QUOTES.length); attempts++; } if(idx===lastIndex) idx = (lastIndex+1)%QUOTES.length; return idx; }

    function computeMedalByStreak(streak){ const achieved = MEDALS.filter(m=>streak>=m.days).sort((a,b)=>b.days-a.days); return achieved.length?achieved[0]:null; }

    function getPrevThreshold(days){ let prev = 0; for(let i=0;i<MEDALS.length;i++){ if(MEDALS[i].days>=days) { return prev; } prev = MEDALS[i].days; } return prev; }

    function renderMedalsUI(currentStreak){ medalStrip.innerHTML = ''; const maxDays = MEDALS[MEDALS.length-1].days; MEDALS.forEach(m=>{ const card = document.createElement('div'); card.className = 'medal-card'; if(currentStreak >= m.days) card.style.boxShadow = '0 10px 24px rgba(58,88,160,.08)'; const top = document.createElement('div'); top.className='medal-top'; const tag = document.createElement('div'); tag.className='medal-tag'; tag.innerHTML = m.svg; const nameWrap = document.createElement('div'); const name = document.createElement('div'); name.className='medal-name'; name.textContent = m.name; const days = document.createElement('div'); days.className='medal-days'; days.textContent = `za ${m.days} CytatPunkty`; nameWrap.appendChild(name); nameWrap.appendChild(days); top.appendChild(tag); top.appendChild(nameWrap); const bottom = document.createElement('div'); const prevThreshold = getPrevThreshold(m.days); const progressLocal = ((Math.min(currentStreak, m.days) - prevThreshold) / Math.max(1, (m.days - prevThreshold))) * 100; const barHtml = `<div style="height:10px;background:rgba(30,58,138,.06);border-radius:8px;overflow:hidden;margin-top:8px"><div style="width:${Math.max(0,Math.min(100,progressLocal))}%";height:100%;background:linear-gradient(90deg,var(--quote-grad-start),var(--quote-grad-end))></div></div>`; const missing = Math.max(0, m.days - currentStreak); const missingText = missing === 0 ? 'Zdobyte' : `Brakuje: ${missing} CytatPunkty`; bottom.innerHTML = barHtml + `<div class="medal-missing">${missingText}</div>`; const cap = medalCaptionFor(m.name); const captionDiv = document.createElement('div'); captionDiv.className = `medal-caption ${cap.cls}`; captionDiv.textContent = cap.text; bottom.appendChild(captionDiv); card.appendChild(top); card.appendChild(bottom); medalStrip.appendChild(card); });

      const state = loadState(); const claimed = state.claimedMedals || [];
      const next = nextMedal(currentStreak);
      let fillPercent = 0; let prev = 0; let goal = maxDays; let localProgress = 0;
      if(next){ prev = getPrevThreshold(next.days); goal = Math.max(1, next.days - prev); localProgress = Math.max(0, currentStreak - prev); fillPercent = Math.min(100, Math.round((localProgress / goal) * 100)); } else { fillPercent = 100; }
      progressFill.style.width = fillPercent + '%';

      const existingPopup = progressWrap.querySelector('.progress-popup'); if(existingPopup) existingPopup.remove();

      progressWrap.onclick = function(e){ e.stopPropagation(); const p = progressWrap.querySelector('.progress-popup'); if(p){ p.remove(); return; } const popup = document.createElement('div'); popup.className = 'progress-popup'; popup.style.position='absolute'; popup.style.left='50%'; popup.style.transform='translateX(-50%)'; popup.style.top='-70px'; popup.style.background='#fff'; popup.style.padding='10px'; popup.style.borderRadius='10px'; popup.style.boxShadow='0 8px 22px rgba(0,0,0,0.12)'; popup.style.zIndex=999;
        if(next){ const current = Math.max(0, currentStreak - prev); popup.innerHTML = `<div style="font-weight:700;margin-bottom:6px">${current} z ${goal} CytatPunkty do ${next.name}</div>`; if(currentStreak >= next.days && !claimed.includes(next.days)){ const btn = document.createElement('button'); btn.className='claim-btn'; btn.textContent='Odbierz'; btn.addEventListener('click',(ev)=>{ ev.stopPropagation(); const s = loadState(); const cm = s.claimedMedals || []; if(!cm.includes(next.days)) cm.push(next.days); saveState({claimedMedals: cm}); popup.remove(); renderMedalsUI(currentStreak); setTimeout(()=>{ alert(`Gratulacje! Otrzymałeś medal: ${next.emoji} ${next.name}`); },120); }); popup.appendChild(btn); }
        } else { popup.innerHTML = `<div style="font-weight:700">Osiągnięto wszystkie medale 🎉</div>`; }
        progressWrap.appendChild(popup);
      };

      if(next){ const missingToNext = Math.max(0, next.days - currentStreak); progressLegendLeft.textContent = `Twoja CytatPassa: ${currentStreak} dni • Do ${next.name}: ${missingToNext} CytatPunkty`; } else { progressLegendLeft.textContent = `Twoja CytatPassa: ${currentStreak} dni • Osiągnięto wszystkie medale 🎉`; }
      progressLegendRight.textContent = `Cel: ${MEDALS[MEDALS.length-1].days} CytatPunkty`;

      medalStrip.style.scrollBehavior = 'smooth';
      medalStrip.querySelectorAll('.medal-card').forEach((c,i)=>{ c.setAttribute('role','group'); c.setAttribute('aria-label', `${MEDALS[i].name} ${MEDALS[i].days} CytatPunkty`); });
    }

    // initial render
    (function init(){ const state = loadState(); // ensure points at least equals streak (domyślne zachowanie)
      const pointsVal = Math.max(state.points || 0, state.streak || 0);
      saveState({ points: pointsVal }); // ensure saved
      streakValueEl.textContent = (state.streak || 0);
      pointsValueEl.textContent = pointsVal;
      if(state.lastQuoteIndex!==null && state.lastQuoteIndex!==undefined){ const q = QUOTES[state.lastQuoteIndex]; if(q){ quoteText.textContent = q.text; quoteRef.textContent = q.ref; } }
      renderMedalsUI(state.streak||0); renderHistory(); updateCountdown(); setInterval(updateCountdown,1000); })();

    // draw logic
    drawBtn.addEventListener('click',()=>{ const today = getTodayKey(); const state = loadState(); if(state.lastDrawDate===today){ alert('Dzisiaj już losowano cytat. Spróbuj jutro.'); return; } let newStreak = 1; if(state.lastDrawDate){ const diffDays = daysBetween(state.lastDrawDate, today); if(diffDays===1){ newStreak = (state.streak||0) + 1; } else if(diffDays===0){ newStreak = state.streak||1; } else { newStreak = 1; } } const idx = chooseQuoteAvoidRepeat(state.lastQuoteIndex); const chosen = QUOTES[idx]; quoteText.textContent = chosen.text; quoteRef.textContent = chosen.ref; // update streak and points
      const existingPoints = state.points || 0;
      const newPoints = Math.max(existingPoints, newStreak); // punkty nie maleją poniżej passy
      streakValueEl.textContent = newStreak;
      pointsValueEl.textContent = newPoints;
      const hist = state.history||[]; const lastEntry = hist.length?hist[hist.length-1]:null; if(!lastEntry || lastEntry.date !== today){ hist.push({date: today, text: chosen.text, ref: chosen.ref}); if(hist.length>365) hist.shift(); } saveState({lastDrawDate: today, lastQuoteIndex: idx, streak: newStreak, history: hist, points: newPoints}); renderMedalsUI(newStreak); renderHistory(); quoteBoxAnim(); updateCountdown(); const achieved = computeMedalByStreak(newStreak); if(achieved){ const previousBest = MEDALS.slice().reverse().find(m=> (state.streak||0) >= m.days ); const prevDays = previousBest?previousBest.days:0; if(achieved.days>prevDays){ setTimeout(()=>{ alert(`Gratulacje! Zdobyłeś medal: ${achieved.emoji} ${achieved.name} (passa ${achieved.days} dni)`); },300); } } });

    function renderHistory(){ const state = loadState(); const hist = state.history || []; if(hist.length===0){ historyList.innerHTML='Brak zapisanych cytatów.'; return; } historyList.innerHTML=''; hist.slice().reverse().forEach(h=>{ const div = document.createElement('div'); div.className = 'history-item'; div.textContent = `${h.date} — ${h.text} (${h.ref})`; historyList.appendChild(div); }); }

    function quoteBoxAnim(){ const box = document.getElementById('quoteBox'); if(!box.animate) return; box.animate([ { transform: 'translateY(0) scale(1)', boxShadow: '0 8px 20px rgba(58,88,160,.12)' }, { transform: 'translateY(-6px) scale(1.01)', boxShadow: '0 18px 30px rgba(58,88,160,.16)' }, { transform: 'translateY(0) scale(1)', boxShadow: '0 8px 20px rgba(58,88,160,.12)' } ],{ duration: 600, easing: 'ease-out' }); }

    /* ---------- NEW FEATURES ---------- */

    // 1) Clear history button
    clearHistoryBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      if(!confirm('Czy na pewno chcesz usunąć całą historię cytatów? Operacji nie można cofnąć.')) return;
      const s = loadState();
      s.history = [];
      saveState({ history: [] });
      renderHistory();
      alert('Historia cytatów została wyczyszczona.');
    });

    // 2) Search/code popup toggle (right icon)
    searchToggle.addEventListener('click', (e) => {
      e.stopPropagation();
      codeMsg.style.display = 'none';
      codeMsg.textContent = '';
      codeInput.value = '';
      codePopup.classList.toggle('visible');
      codePopup.setAttribute('aria-hidden', codePopup.classList.contains('visible') ? 'false' : 'true');
      if(codePopup.classList.contains('visible')) codeInput.focus();
    });

    // close popups when clicking outside
    document.addEventListener('click', (ev) => {
      if(codePopup.classList.contains('visible')){
        codePopup.classList.remove('visible');
        codePopup.setAttribute('aria-hidden','true');
      }
      // remove any progress popup if open
      const p = progressWrap.querySelector('.progress-popup');
      if(p) p.remove();
    });

    // prevent clicks inside popup from closing it
    codePopup.addEventListener('click', (ev)=>{ ev.stopPropagation(); });

    // 3) Apply special code (hidden code handling)
    // NOTE: The code string is not displayed anywhere in UI; usage stored locally under claimedCodes
    function applySpecialCode(rawCode){
      const code = (rawCode||'').toString().trim().toUpperCase();
      if(!code) return { ok:false, msg:'Wpisz kod.' };
      const state = loadState();
      const claimed = state.claimedCodes || [];

      // QQWE19 -> +30 dni do passy i +30 CytatPunktów (jednorazowo)
      if(code === 'QQWE19'){
        if(claimed.includes(code)){
          return { ok:false, msg:'Kod został już użyty.' };
        }
        const newStreak = (state.streak || 0) + 30;
        const newPoints = (state.points || 0) + 30;
        claimed.push(code);
        saveState({ streak: newStreak, points: newPoints, claimedCodes: claimed });
        streakValueEl.textContent = newStreak;
        pointsValueEl.textContent = newPoints;
        renderMedalsUI(newStreak);
        updateCountdown();
        return { ok:true, msg:'+30 dni do CytatPassy i +30 CytatPunktów zostało dodane. Dziękujemy!' };
      }

      // Kody AABBxx -> +2 CytatPunkty (jednorazowo)
      const smallPointCodes = ['AABB12','AABB34','AABB95','AABB00'];
      if(smallPointCodes.includes(code)){
        if(claimed.includes(code)){
          return { ok:false, msg:'Kod został już użyty.' };
        }
        const newPoints = (state.points || 0) + 2;
        claimed.push(code);
        saveState({ points: newPoints, claimedCodes: claimed });
        pointsValueEl.textContent = newPoints;
        renderMedalsUI(state.streak || 0);
        return { ok:true, msg:'+2 CytatPunkty zostały dodane.' };
      }

      // Kody QQBExx -> +10 CytatPunkty (jednorazowo)
      const bigPointCodes = ['QQBE12','QQBE19','QQBE48'];
      if(bigPointCodes.includes(code)){
        if(claimed.includes(code)){
          return { ok:false, msg:'Kod został już użyty.' };
        }
        const newPoints = (state.points || 0) + 10;
        claimed.push(code);
        saveState({ points: newPoints, claimedCodes: claimed });
        pointsValueEl.textContent = newPoints;
        renderMedalsUI(state.streak || 0);
        return { ok:true, msg:'+10 CytatPunktów zostało dodane.' };
      }

      return { ok:false, msg:'Nieprawidłowy kod.' };
    }

    // handle form submit
    codeForm.addEventListener('submit', (ev) => {
      ev.preventDefault();
      ev.stopPropagation();
      const v = codeInput.value || '';
      const res = applySpecialCode(v);
      codeMsg.style.display = 'block';
      codeMsg.textContent = res.msg;
      if(res.ok){
        // show brief success then hide popup
        setTimeout(()=>{ codePopup.classList.remove('visible'); codePopup.setAttribute('aria-hidden','true'); }, 900);
        // subtle alert for immediate feedback
        alert('Kod przyjęty — ' + res.msg);
      }
    });

    /* ---------- end new features ---------- */

    console.info('Codzienny Cytat - aplikacja załadowana. CytatPunkty dodane. Aby zresetować storagę: localStorage.clear()');
  </script>
</body>
</html>
